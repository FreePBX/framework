{"version":3,"sources":["../../src/lib/Kvstore.js"],"names":["Kvstore","db","version","module","key","id","resolve","reject","sql","fields","split","join","query","then","results","parseResult","result","catch","settings","each","row","callback","res","err","value","type","JSON","stringify","length","deleteBlob","val","insertBlob","uid","affectedRows","error","uuid","Error","sqlState","createKvblobstore","content","iid","parse","toString","getBlob"],"mappings":"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","file":"Kvstore.js","sourcesContent":["import { Promise } from 'bluebird';\nimport async from 'async';\nimport versionCompare from 'locutus/php/info/version_compare';\nimport uuidv4 from 'uuid/v4';\n\nexport default class Kvstore {\n\tconstructor({db, version}) {\n\t\tthis.db = db;\n\t\tthis.version = versionCompare(version,\"14.0\",\"<\") ? \"13\" : \"14\";\n\t}\n\n\tgetConfig(module, key = null, id = 'noid') {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tlet sql\n\t\t\tlet fields = []\n\t\t\tif(this.version != '13') {\n\t\t\t\tsql = 'SELECT * FROM ?? WHERE `key` = ? AND `id` = ?'\n\t\t\t\tfields = [\n\t\t\t\t\t'kvstore_' + module.split('\\\\').join('_'),\n\t\t\t\t\tkey,\n\t\t\t\t\tid\n\t\t\t\t]\n\t\t\t} else {\n\t\t\t\tsql = 'SELECT * FROM `kvstore` WHERE `module` = ? AND `key` = ? AND `id` = ?'\n\t\t\t\tfields = [\n\t\t\t\t\tmodule,\n\t\t\t\t\tkey,\n\t\t\t\t\tid\n\t\t\t\t]\n\t\t\t}\n\t\t\tthis.query(sql, fields)\n\t\t\t.then(results => {\n\t\t\t\tif(typeof results[0] === \"undefined\") {\n\t\t\t\t\treturn Promise.resolve(false);\n\t\t\t\t} else {\n\t\t\t\t\treturn this.parseResult(results[0])\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then(result  => {\n\t\t\t\tresolve(result)\n\t\t\t})\n\t\t\t.catch(err => {\n\t\t\t\tresolve(false);\n\t\t\t})\n\t\t});\n\t}\n\n\tgetAllConfig(module) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tlet sql\n\t\t\tlet fields = []\n\t\t\tif(this.version != '13') {\n\t\t\t\tsql = 'SELECT * FROM ??'\n\t\t\t\tfields = [\n\t\t\t\t\t'kvstore_' + module.split('\\\\').join('_')\n\t\t\t\t]\n\t\t\t} else {\n\t\t\t\tsql = 'SELECT * FROM `kvstore` WHERE `module` = ?'\n\t\t\t\tfields = [\n\t\t\t\t\tmodule\n\t\t\t\t]\n\t\t\t}\n      this.query(sql, fields)\n\t\t\t.then(results => {\n\t\t\t\tlet settings = {}\n\t\t\t\tasync.each(results, (row, callback) => {\n          this.parseResult(row)\n\t\t\t\t\t.then(res => {\n\t\t\t\t\t\tsettings[row.key] = res\n\t\t\t\t\t\tcallback()\n\t\t\t\t\t})\n\t\t\t\t\t.catch(err => {\n\t\t\t\t\t\tcallback(err)\n\t\t\t\t\t})\n\t\t\t\t}, function(err){\n\t\t\t\t\tif(err){\n\t\t\t\t\t\treturn reject(err)\n\t\t\t\t\t}\n\t\t\t\t\tresolve(settings);\n\t\t\t\t});\n\t\t\t\t//http://bluebirdjs.com/docs/warning-explanations.html#warning-a-promise-was-created-in-a-handler-but-was-not-returned-from-it\n\t\t\t\treturn null\n\t\t\t})\n\t\t\t.catch(err => {\n\t\t\t\tresolve([]);\n\t\t\t})\n\t\t});\n\t}\n\n\tsetConfig(module, key = null, value = false, id = 'noid') {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tlet type = null;\n\t\t\tif(typeof value === \"object\") {\n\t\t\t\ttype = 'json-arr';\n\t\t\t\tvalue = JSON.stringify(value);\n\t\t\t} else if(typeof value === \"boolean\") {\n\t\t\t\tvalue = (value) ? 1 : 0;\n\t\t\t}\n\t\t\tif(this.version != '13') {\n\t\t\t\tif(value.length > 4000) {\n\t\t\t\t\tthis.query(\n\t\t\t\t\t\t'SELECT * FROM ?? WHERE `key` = ? AND `id` = ?' ,\n\t\t\t\t\t\t[\n\t\t\t\t\t\t\t'kvstore_' + module.split('\\\\').join('_'),\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tid\n\t\t\t\t\t\t]\n\t\t\t\t\t)\n\t\t\t\t\t.then(results => {\n\t\t\t\t\t\tif(results.length) {\n\t\t\t\t\t\t\treturn this.deleteBlob(results[0].val)\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treturn Promise.resolve(null)\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\t.then(result => {\n\t\t\t\t\t\tif(result) {\n\t\t\t\t\t\t\treturn this.query(\n\t\t\t\t\t\t\t\t'DELETE FROM ?? WHERE `key` = ? AND `id` = ?' ,\n\t\t\t\t\t\t\t\t[\n\t\t\t\t\t\t\t\t\t'kvstore_' + module.split('\\\\').join('_'),\n\t\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\t\tid\n\t\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treturn Promise.resolve(null)\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\t.then(result => {\n\t\t\t\t\t\treturn this.insertBlob(value, type)\n\t\t\t\t\t})\n\t\t\t\t\t.then(uid => {\n\t\t\t\t\t\treturn this.query(\n\t\t\t\t\t\t\t'REPLACE INTO ?? (`key`,`val`,`type`,`id`) VALUES (?,?,?,?)',\n\t\t\t\t\t\t\t[\n\t\t\t\t\t\t\t\t'kvstore_' + module.split('\\\\').join('_'),\n\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\tuid,\n\t\t\t\t\t\t\t\t'blob',\n\t\t\t\t\t\t\t\tid\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t)\n\t\t\t\t\t})\n\t\t\t\t\t.then(results => {\n\t\t\t\t\t\tresolve(results.affectedRows);\n\t\t\t\t\t})\n\t\t\t\t\t.catch(error => {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t})\n\t\t\t\t} else {\n\t\t\t\t\tthis.query(\n\t\t\t\t\t\t'REPLACE INTO ?? (`key`,`val`,`type`,`id`) VALUES (?,?,?,?)',\n\t\t\t\t\t\t[\n\t\t\t\t\t\t\t'kvstore_' + module.split('\\\\').join('_'),\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue,\n\t\t\t\t\t\t\ttype,\n\t\t\t\t\t\t\tid\n\t\t\t\t\t\t]\n\t\t\t\t\t)\n\t\t\t\t\t.then(results => {\n\t\t\t\t\t\tresolve(results.affectedRows);\n\t\t\t\t\t})\n\t\t\t\t\t.catch(error => {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthis.query(\n\t\t\t\t\t'REPLACE INTO `kvstore` (`module`,`key`,`val`,`type`,`id`) VALUES (?,?,?,?,?)',\n\t\t\t\t\t[\n\t\t\t\t\t\tmodule,\n\t\t\t\t\t\tkey,\n\t\t\t\t\t\tvalue,\n\t\t\t\t\t\ttype,\n\t\t\t\t\t\tid\n\t\t\t\t\t]\n\t\t\t\t)\n\t\t\t\t.then(results => {\n\t\t\t\t\tresolve(results.affectedRows);\n\t\t\t\t})\n\t\t\t\t.catch(error => {\n\t\t\t\t\treject(error);\n\t\t\t\t})\n\t\t\t}\n\t\t});\n\t}\n\n\tdeleteBlob(uuid = false) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (!uuid) {\n\t\t\t\treturn reject(new Error(\"No uuid\"));\n\t\t\t}\n      this.query('DELETE FROM `kvblobstore` WHERE `uuid`= ?', [uuid])\n\t\t\t.then(results => {\n\t\t\t\tresolve(true)\n\t\t\t})\n\t\t\t.catch(error => {\n\t\t\t\tif (error.sqlState == \"42S02\") {\n\t\t\t\t\treturn this.createKvblobstore()\n\t\t\t\t\t.then(r => {\n\t\t\t\t\t\tresolve(true);\n\t\t\t\t\t})\n\t\t\t\t\t.catch(error => {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t})\n\t\t\t\t} else {\n\t\t\t\t\treject(error);\n\t\t\t\t}\n\t\t\t})\n\t\t})\n\t}\n\n\tgetBlob(uuid = false) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (!uuid) {\n\t\t\t\treturn reject(new Error(\"No uuid\"));\n\t\t\t}\n\t\t\tthis.query('SELECT * FROM `kvblobstore` WHERE `uuid`=?' , [uuid])\n\t\t\t.then(results => {\n\t\t\t\tif(!results[0]) {\n\t\t\t\t\tresolve({\n\t\t\t\t\t\t\"content\": \"\",\n\t\t\t\t\t\t\"type\": false\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tresolve({\n\t\t\t\t\t\t\"content\": results[0].content,\n\t\t\t\t\t\t\"type\": results[0].type\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(error => {\n\t\t\t\tif (error.sqlState == \"42S02\") {\n\t\t\t\t\tthis.createKvblobstore()\n\t\t\t\t\t.then(r => {\n\t\t\t\t\t\tresolve({\n\t\t\t\t\t\t\t\"content\": \"\",\n\t\t\t\t\t\t\t\"type\": false\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t\t\t.catch(error => {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t})\n\t\t\t\t} else {\n\t\t\t\t\treject(error);\n\t\t\t\t}\n\t\t\t})\n\t\t})\n\t}\n\n\tinsertBlob(val = false, type = \"raw\") {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (!val) {\n\t\t\t\treturn reject(new Error(\"No val\"));\n\t\t\t}\n\t\t\tconst id = uuidv4()\n\t\t\t// Try to insert our value\n\t\t\tthis.query(\n\t\t\t\t'INSERT INTO `kvblobstore` (`uuid`, `type`, `content`) VALUES (?, ?, ?)',\n\t\t\t\t[\n\t\t\t\t\tid,\n\t\t\t\t\ttype,\n\t\t\t\t\tval\n\t\t\t\t]\n\t\t\t)\n\t\t\t.then(results => {\n\t\t\t\tresolve(id)\n\t\t\t})\n\t\t\t.catch(error => {\n\t\t\t\tif (error.sqlState == \"42S02\") {\n\t\t\t\t\tthis.createKvblobstore()\n\t\t\t\t\t.then(r => {\n\t\t\t\t\t\tthis.insertBlob(val, type)\n\t\t\t\t\t})\n\t\t\t\t\t.then(iid => {\n\t\t\t\t\t\tresolve(iid)\n\t\t\t\t\t})\n\t\t\t\t\t.catch(error => {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t})\n\t\t\t\t} else {\n\t\t\t\t\treject(error);\n\t\t\t\t}\n\t\t\t})\n\t\t})\n\t}\n\n\tcreateKvblobstore() {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.query('CREATE TABLE `kvblobstore` ( `uuid` CHAR(36) PRIMARY KEY, `type` CHAR(32), `content` LONGBLOB )')\n\t\t\t.then(results => {\n\t\t\t\tresolve(true)\n\t\t\t})\n\t\t\t.catch(error => {\n\t\t\t\treject(error)\n\t\t\t})\n\t\t})\n\n\t}\n\n\tdelConfig(module, key = null, id = 'noid') {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif(this.version != '13') {\n\t\t\t\tthis.query(\n\t\t\t\t\t'SELECT * FROM ?? WHERE `key` = ? AND `id` = ?' ,\n\t\t\t\t\t[\n\t\t\t\t\t\t'kvstore_' + module.split('\\\\').join('_'),\n\t\t\t\t\t\tkey,\n\t\t\t\t\t\tid\n\t\t\t\t\t]\n\t\t\t\t)\n\t\t\t\t.then(results => {\n\t\t\t\t\tif(results.length > 1) {\n\t\t\t\t\t\treturn this.deleteBlob(results[0].val)\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn Promise.resolve(null)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.then(result => {\n\t\t\t\t\treturn this.query(\n\t\t\t\t\t\t'DELETE FROM ?? WHERE `key` = ? AND `id` = ?' ,\n\t\t\t\t\t\t[\n\t\t\t\t\t\t\t'kvstore_' + module.split('\\\\').join('_'),\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tid\n\t\t\t\t\t\t]\n\t\t\t\t\t)\n\t\t\t\t})\n          .then(res => {\n            resolve(true)\n          })\n\t\t\t\t.catch(error => {\n\t\t\t\t\treject(error);\n\t\t\t\t})\n\t\t\t} else {\n\t\t\t\tthis.query(\n\t\t\t\t\t'DELETE FROM `kvstore` WHERE `module` = ? AND `key` = ? AND `id` = ?' ,\n\t\t\t\t\t[\n\t\t\t\t\t\tmodule,\n\t\t\t\t\t\tkey,\n\t\t\t\t\t\tid\n\t\t\t\t\t]\n\t\t\t\t)\n\t\t\t\t.then(results => {\n\t\t\t\t\tresolve(true);\n\t\t\t\t})\n\t\t\t\t.catch(error => {\n\t\t\t\t\treject(error);\n\t\t\t\t})\n\t\t\t}\n\t\t});\n\t}\n\n\tparseResult(result) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tswitch(result.type) {\n\t\t\t\tcase 'json-arr':\n\t\t\t\t\ttry {\n\t\t\t\t\t\tresolve(JSON.parse(result.val))\n\t\t\t\t\t} catch(err) {\n\t\t\t\t\t\tresolve(result.val.toString('utf8'))\n\t\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t\tcase 'blob':\n\t\t\t\t\tconst id = result.val.toString('utf8')\n\t\t\t\t\tthis.getBlob(id)\n\t\t\t\t\t.then(result => {\n\t\t\t\t\t\tif(result.type == 'json-arr') {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tresolve(JSON.parse(result.content))\n\t\t\t\t\t\t\t} catch(err) {\n\t\t\t\t\t\t\t\tresolve(result.content.toString('utf8'))\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tresolve(result.content.toString('utf8'))\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\t.catch(error => {\n\t\t\t\t\t\treject(error)\n\t\t\t\t\t})\n\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tresolve(result.val.toString('utf8'))\n\t\t\t\tbreak;\n\t\t\t}\n\t\t})\n\n\t}\n\n\tquery(sql, fields = []) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.db.query(sql, fields, (error, results, fields) => {\n\t\t\t\tif(error) {\n\t\t\t\t\treturn reject(error);\n\t\t\t\t}\n\t\t\t\tresolve(results);\n\t\t\t});\n\t\t})\n\t}\n}\n"]}